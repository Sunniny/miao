import{f as Y,g as M,U as j,j as Ne,I as B,d as K,b as l,ab as W,ac as ve,ar as me,H as Re,P as Ve,T as Z,v as U,X as ee,at as pe,n as J,au as ze,a4 as Q,i as $e,D as ge,av as he,k as x,B as ye,aw as Ee,ax as Ue,ak as g,l as C,ay as Me,ai as Le,ah as je,az as Fe,L as He,aA as Ke,r as z,c as S,a as h,w as F,ap as D,e as se,am as re,an as le,ao as ie,aB as ce,aq as G,o as _,a7 as We}from"./index-11d64c67.js";import{p as be,b as qe,P as te,L as we}from"./index-15213e54.js";import{m as ke,u as Ce}from"./mount-component-d6395caf.js";const[Xe,k]=Y("action-sheet"),Ge=M({},be,{title:String,round:j,actions:Ne(),closeIcon:B("cross"),closeable:j,cancelText:String,description:String,closeOnPopstate:j,closeOnClickAction:Boolean,safeAreaInsetBottom:j}),Je=[...qe,"round","closeOnPopstate","safeAreaInsetBottom"];var Qe=K({name:Xe,props:Ge,emits:["select","cancel","update:show"],setup(e,{slots:t,emit:a}){const i=o=>a("update:show",o),v=()=>{i(!1),a("cancel")},m=()=>{if(e.title)return l("div",{class:k("header")},[e.title,e.closeable&&l(me,{name:e.closeIcon,class:[k("close"),Re],onClick:v},null)])},f=()=>{if(t.cancel||e.cancelText)return[l("div",{class:k("gap")},null),l("button",{type:"button",class:k("cancel"),onClick:v},[t.cancel?t.cancel():e.cancelText])]},n=(o,s)=>o.loading?l(we,{class:k("loading-icon")},null):t.action?t.action({action:o,index:s}):[l("span",{class:k("name")},[o.name]),o.subname&&l("div",{class:k("subname")},[o.subname])],c=(o,s)=>{const{color:p,loading:O,callback:I,disabled:y,className:L}=o,N=()=>{y||O||(I&&I(o),e.closeOnClickAction&&i(!1),Ve(()=>a("select",o,s)))};return l("button",{type:"button",style:{color:p},class:[k("item",{loading:O,disabled:y}),L],onClick:N},[n(o,s)])},u=()=>{if(e.description||t.description){const o=t.description?t.description():e.description;return l("div",{class:k("description")},[o])}};return()=>l(te,W({class:k(),position:"bottom","onUpdate:show":i},ve(e,Je)),{default:()=>{var o;return[m(),u(),l("div",{class:k("content")},[e.actions.map(c),(o=t.default)==null?void 0:o.call(t)]),f()]}})}});const Ye=Z(Qe);let $=0;function Ze(e){e?($||document.body.classList.add("van-toast--unclickable"),$++):$&&($--,$||document.body.classList.remove("van-toast--unclickable"))}const[et,A]=Y("toast"),tt=["show","overlay","teleport","transition","overlayClass","overlayStyle","closeOnClickOverlay"],nt={icon:String,show:Boolean,type:B("text"),overlay:Boolean,message:J,iconSize:J,duration:ze(2e3),position:B("middle"),teleport:[String,Object],wordBreak:String,className:Q,iconPrefix:String,transition:B("van-fade"),loadingType:String,forbidClick:Boolean,overlayClass:Q,overlayStyle:Object,closeOnClick:Boolean,closeOnClickOverlay:Boolean};var xe=K({name:et,props:nt,emits:["update:show"],setup(e,{emit:t,slots:a}){let i,v=!1;const m=()=>{const s=e.show&&e.forbidClick;v!==s&&(v=s,Ze(v))},f=s=>t("update:show",s),n=()=>{e.closeOnClick&&f(!1)},c=()=>clearTimeout(i),u=()=>{const{icon:s,type:p,iconSize:O,iconPrefix:I,loadingType:y}=e;if(s||p==="success"||p==="fail")return l(me,{name:s||p,size:O,class:A("icon"),classPrefix:I},null);if(p==="loading")return l(we,{class:A("loading"),size:O,type:y},null)},o=()=>{const{type:s,message:p}=e;if(a.message)return l("div",{class:A("text")},[a.message()]);if($e(p)&&p!=="")return s==="html"?l("div",{key:0,class:A("text"),innerHTML:String(p)},null):l("div",{class:A("text")},[p])};return U(()=>[e.show,e.forbidClick],m),U(()=>[e.show,e.type,e.message,e.duration],()=>{c(),e.show&&e.duration>0&&(i=setTimeout(()=>{f(!1)},e.duration))}),ee(m),pe(m),()=>l(te,W({class:[A([e.position,e.wordBreak==="normal"?"break-normal":e.wordBreak,{[e.type]:!e.icon}]),e.className],lockScroll:!1,onClick:n,onClosed:c,"onUpdate:show":f},ve(e,tt)),{default:()=>[u(),o()]})}});const ot={icon:"",type:"text",message:"",className:"",overlay:!1,onClose:void 0,onOpened:void 0,duration:2e3,teleport:"body",iconSize:void 0,iconPrefix:void 0,position:"middle",transition:"van-fade",forbidClick:!1,loadingType:void 0,overlayClass:"",overlayStyle:void 0,closeOnClick:!1,closeOnClickOverlay:!1};let H=[],at=!1,ue=M({},ot);const st=new Map;function rt(e){return he(e)?e:{message:e}}function lt(){const{instance:e,unmount:t}=ke({setup(){const a=x(""),{open:i,state:v,close:m,toggle:f}=Ce(),n=()=>{},c=()=>l(xe,W(v,{onClosed:n,"onUpdate:show":f}),null);return U(a,u=>{v.message=u}),ye().render=c,{open:i,close:m,message:a}}});return e}function it(){if(!H.length||at){const e=lt();H.push(e)}return H[H.length-1]}function ct(e={}){if(!ge)return{};const t=it(),a=rt(e);return t.open(M({},ue,st.get(a.type||ue.type),a)),t}Z(xe);const[ut,dt]=Y("notify"),ft=M({},be,{type:B("danger"),color:String,message:J,position:B("top"),className:Q,background:String,lockScroll:Boolean});var Se=K({name:ut,props:ft,emits:["update:show"],setup(e,{emit:t,slots:a}){const i=v=>t("update:show",v);return()=>l(te,{show:e.show,class:[dt([e.type]),e.className],style:{color:e.color,background:e.background},overlay:!1,zIndex:e.zIndex,position:e.position,duration:.2,lockScroll:e.lockScroll,"onUpdate:show":i},{default:()=>[a.default?a.default():e.message]})}});let de,T;const vt=e=>he(e)?e:{message:e};function mt(){({instance:T}=ke({setup(){const{state:e,toggle:t}=Ce();return()=>l(Se,W(e,{"onUpdate:show":t}),null)}}))}const pt=()=>({type:"danger",color:void 0,message:"",onClose:void 0,onClick:void 0,onOpened:void 0,duration:3e3,position:void 0,className:"",lockScroll:!1,background:void 0});let gt=pt();const ht=()=>{T&&T.toggle(!1)};function yt(e){if(ge)return T||mt(),e=M({},gt,vt(e)),T.open(e),clearTimeout(de),e.duration>0&&(de=setTimeout(ht,e.duration)),T}Z(Se);function bt(e){return Ee()?(Ue(e),!0):!1}function wt(e){return typeof e=="function"?e():g(e)}const kt=typeof window<"u"&&typeof document<"u";function E(e){var t;const a=wt(e);return(t=a==null?void 0:a.$el)!=null?t:a}const _e=kt?window:void 0;function Ct(){const e=x(!1);return ye()&&ee(()=>{e.value=!0}),e}function xt(e){const t=Ct();return C(()=>(t.value,!!e()))}function St(e,t,a={}){const{window:i=_e,...v}=a;let m;const f=xt(()=>i&&"ResizeObserver"in i),n=()=>{m&&(m.disconnect(),m=void 0)},c=C(()=>Array.isArray(e)?e.map(s=>E(s)):[E(e)]),u=U(c,s=>{if(n(),f.value&&i){m=new ResizeObserver(t);for(const p of s)p&&m.observe(p,v)}},{immediate:!0,flush:"post",deep:!0}),o=()=>{n(),u()};return bt(o),{isSupported:f,stop:o}}function _t(e,t={width:0,height:0},a={}){const{window:i=_e,box:v="content-box"}=a,m=C(()=>{var c,u;return(u=(c=E(e))==null?void 0:c.namespaceURI)==null?void 0:u.includes("svg")}),f=x(t.width),n=x(t.height);return St(e,([c])=>{const u=v==="border-box"?c.borderBoxSize:v==="content-box"?c.contentBoxSize:c.devicePixelContentBoxSize;if(i&&m.value){const o=E(e);if(o){const s=i.getComputedStyle(o);f.value=Number.parseFloat(s.width),n.value=Number.parseFloat(s.height)}}else if(u){const o=Array.isArray(u)?u:[u];f.value=o.reduce((s,{inlineSize:p})=>s+p,0),n.value=o.reduce((s,{blockSize:p})=>s+p,0)}else f.value=c.contentRect.width,n.value=c.contentRect.height},a),U(()=>E(e),c=>{f.value=c?t.width:0,n.value=c?t.height:0}),{width:f,height:n}}var Ot=function(){var e=document.getSelection();if(!e.rangeCount)return function(){};for(var t=document.activeElement,a=[],i=0;i<e.rangeCount;i++)a.push(e.getRangeAt(i));switch(t.tagName.toUpperCase()){case"INPUT":case"TEXTAREA":t.blur();break;default:t=null;break}return e.removeAllRanges(),function(){e.type==="Caret"&&e.removeAllRanges(),e.rangeCount||a.forEach(function(v){e.addRange(v)}),t&&t.focus()}},It=Ot,fe={"text/plain":"Text","text/html":"Url",default:"Text"},Pt="Copy to clipboard: #{key}, Enter";function Dt(e){var t=(/mac os x/i.test(navigator.userAgent)?"⌘":"Ctrl")+"+C";return e.replace(/#{\s*key\s*}/g,t)}function At(e,t){var a,i,v,m,f,n,c=!1;t||(t={}),a=t.debug||!1;try{v=It(),m=document.createRange(),f=document.getSelection(),n=document.createElement("span"),n.textContent=e,n.ariaHidden="true",n.style.all="unset",n.style.position="fixed",n.style.top=0,n.style.clip="rect(0, 0, 0, 0)",n.style.whiteSpace="pre",n.style.webkitUserSelect="text",n.style.MozUserSelect="text",n.style.msUserSelect="text",n.style.userSelect="text",n.addEventListener("copy",function(o){if(o.stopPropagation(),t.format)if(o.preventDefault(),typeof o.clipboardData>"u"){a&&console.warn("unable to use e.clipboardData"),a&&console.warn("trying IE specific stuff"),window.clipboardData.clearData();var s=fe[t.format]||fe.default;window.clipboardData.setData(s,e)}else o.clipboardData.clearData(),o.clipboardData.setData(t.format,e);t.onCopy&&(o.preventDefault(),t.onCopy(o.clipboardData))}),document.body.appendChild(n),m.selectNodeContents(n),f.addRange(m);var u=document.execCommand("copy");if(!u)throw new Error("copy command was unsuccessful");c=!0}catch(o){a&&console.error("unable to copy using execCommand: ",o),a&&console.warn("trying IE specific stuff");try{window.clipboardData.setData(t.format||"text",e),t.onCopy&&t.onCopy(window.clipboardData),c=!0}catch(s){a&&console.error("unable to copy using clipboardData: ",s),a&&console.error("falling back to prompt"),i=Dt("message"in t?t.message:Pt),window.prompt(i,e)}}finally{f&&(typeof f.removeRange=="function"?f.removeRange(m):f.removeAllRanges()),n&&document.body.removeChild(n),v()}return c}var Bt=At;const Tt=Me(Bt),Nt={class:"bg-gray-100 h-[100vh] flex flex-col gap-4"},Rt={class:"p-4 text-xl"},Vt={class:"my-4 mx-4 relative"},zt={class:"text-3xl font-bold mb-4"},$t={class:"text-blue-500"},Et={class:"space-y-4"},Ut=["onClick"],Mt={class:"relative h-12 flex gap-2 items-center mx-4"},Lt={key:0,class:"animate-spin flex items-center"},jt={key:1},Ft={class:"ml-auto"},Ht={class:"w-14 text-right"},Kt=["src"],Wt={class:"flex justify-between items-center text-slate-400 px-4"},qt=["disabled"],Qt=K({__name:"Vote",async setup(e){let t,a;var i=Le(),v=i.params.id,m=je(),f=([t,a]=Fe(()=>G.get(`/vote/${v}`)),t=await t,a(),t),n=He(f.data.result),c=C(()=>n.vote.multiple?"[多选]":"[单选]"),u=x(!1),o=[{name:"复制链接",callback:function(){Tt(location.href),ct({message:"复制成功",position:"top"}),yt({type:"success",message:"复制成功"})}},{name:"分享到朋友圈"},{name:"发送给朋友"}],s=C(()=>{var r={};for(var d of n.options)r[d.optionId]=n.userVotes.filter(b=>b.optionId==d.optionId);return r}),p=C(()=>{var r=new Set(n.userVotes.map(P=>P.userId)).size,d={};for(var b in s.value){var R=s.value[b];r==0?d[b]="0%":d[b]=(R.length/r*100).toFixed(1)+"%"}return d}),O=C(()=>{var r={};for(var d in s.value){var b=s.value[d];b.some(R=>{var P;return R.userId==((P=m.user)==null?void 0:P.userId)})?r[d]=!0:r[d]=!1}return r}),I=C(()=>{if(!n.vote.anonymous)return!1;var r=new Date().toISOString();return!(r>n.vote.deadline||n.vote.anonymous&&Object.values(O.value).some(d=>d==!0))}),y=x([]),L=C(()=>{if(I.value){var r={};for(var d of y.value)r[d]=!0;return r}return O.value}),N=x(!1),ne=x(-1),oe=x(null),Oe=C(()=>{var r;return(r=oe.value)==null?void 0:r[0]}),{width:Ie}=_t(Oe);Ke();var Pe=C(()=>Math.floor((Ie.value+8)/40)),q=x(new Array(n.options.length).fill(!0));function ae(r){var{optionId:d}=n.options[r];return q.value[r]?s.value[d]:s.value[d].slice(0,Pe.value)}function De(r){debugger;if(ne.value=r,!n.vote.anonymous)N.value=!0,G.post(`/vote/${n.vote.voteId}`,{optionIds:[r]}).then(b=>{N.value=!1,n.userVotes=b.data.result.userVotes});else if(I.value)if(y.value.includes(r)){var d=y.value.indexOf(r);y.value.splice(d,1)}else n.vote.multiple?y.value.push(r):y.value=[r];else alert("不能投了")}function Ae(){G.post(`/vote/${n.vote.voteId}`,{optionIds:y.value}).then(r=>{n.userVotes=r.data.result.userVotes})}return ee(()=>{var r=new WebSocket(`ws://${location.host}/realtime-voteinfo/${v}`);r.onmessage=d=>{var b=JSON.parse(d.data);n.userVotes=b},pe(()=>{r.close()})}),(r,d)=>{const b=z("RouterLink"),R=z("Share"),P=z("el-icon"),Be=z("Loading"),Te=z("More");return _(),S("div",Nt,[h("h1",Rt,[l(b,{to:"/select-create"},{default:F(()=>[se("腾讯投票")]),_:1})]),h("div",Vt,[h("h2",zt,D(g(n).vote.title),1),h("h3",null,[se(D(g(n).vote.desc)+" ",1),h("span",$t,D(g(c)),1)]),h("span",{onClick:d[0]||(d[0]=w=>re(u)?u.value=!0:u=!0),class:"absolute top-0 right-0 bg-blue-500 flex items-center rounded-full text-white p-2"},[l(P,{size:24},{default:F(()=>[l(R)]),_:1})]),l(g(Ye),{show:g(u),"onUpdate:show":d[1]||(d[1]=w=>re(u)?u.value=w:u=w),description:"分享到...","cancel-text":"取消","close-on-click-action":"",actions:g(o)},null,8,["show","actions"])]),h("ul",Et,[(_(!0),S(le,null,ie(g(n).options,(w,V)=>(_(),S("li",{class:"",key:V},[h("div",{onClick:X=>De(w.optionId),class:"bg-white shadow-lg"},[h("div",Mt,[h("span",null,D(w.content),1),g(N)&&w.optionId==g(ne)?(_(),S("span",Lt,[l(P,null,{default:F(()=>[l(Be)]),_:1})])):(_(),S("span",jt,D(g(L)[w.optionId]?"✔️":""),1)),h("span",Ft,D(g(s)[w.optionId].length)+" 票",1),h("span",Ht,D(g(p)[w.optionId]),1),h("div",{class:"absolute bottom-0 h-[2px] bg-blue-500 transition-all",style:We({width:g(p)[w.optionId]})},null,4)])],8,Ut),!g(n).vote.anonymous&&ae(V).length>0?(_(),S("div",{key:0,ref_for:!0,ref_key:"avatarContainer",ref:oe,class:"flex flex-wrap gap-2 mt-2 mx-4"},[(_(!0),S(le,null,ie(ae(V),X=>(_(),S("img",{class:"align-top inline-block w-8 h-8 rounded-full border border-slate-500",src:X.avatar,alt:""},null,8,Kt))),256)),l(P,{onClick:X=>g(q)[V]=!g(q)[V],class:"align-top inline-block !w-8 !h-8 rounded-full border border-slate-500"},{default:F(()=>[l(Te)]),_:2},1032,["onClick"])],512)):ce("",!0)]))),128))]),h("div",Wt,[h("span",null,"投票截止："+D(new Date(g(n).vote.deadline).toLocaleString()),1)]),g(I)?(_(),S("button",{key:0,onClick:Ae,disabled:g(y).length==0,class:"disabled:bg-gray-500 inline-block mx-4 rounded p-3 bg-blue-500 text-white"},"完成",8,qt)):ce("",!0)])}}});export{Qt as default};
